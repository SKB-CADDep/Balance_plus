# Спецификация продукта «Модуль расчета конденсаторов»

---

**Раздел 1. Общая информация**

| Поле | Значение |
|------|----------|
| Название продукта | Расчётный модуль «Конденсаторы» (Condensers Calc) |
| Заказчик (отдел/человек) | Отдел инженерных расчётов (БТР, БПР, БВП) / Деминов А.М. |
| Аналитик | Шлегин Л.Р., Гаврилов П.Я. |
| Дата передачи в разработку | 16.12.2025 |
| Приоритет | Высокий (Замена Excel-макросов) |
| Целевой срок Demo | Q3 2026 |
| Версия | 1.5 |

---

**Раздел 2. Проблема и цель**

> **Проблема:**
> Текущий процесс расчета конденсаторов фрагментирован и выполняется с помощью Legacy-макроса в Excel.
> - Отсутствует версионирование и централизованное хранение данных (геометрия, результаты).
> - Отсутствует единая БД геометрии конденсаторов.
> - Разрыв контекста: ручной перенос данных (PDF-чертежи → Excel ИД/Результаты).
> - Высокая трудоемкость подготовки данных и формирования таблиц режимов.
>
> **Цель:**
> Автоматизировать расчет конденсаторов в «Едином окне»:
> 1. Создать БД геометрии конденсаторов (включая диапазоны расходов).
> 2. Реализовать расчет по методикам [Бермана](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/balance/CALC-COND-BERMAN.md) и [Метро-Виккерса](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/balance/CALC-COND-METRO_VIKKERS.md).
> 3. Реализовать генерацию многомерных таблиц результатов (параметрический анализ) автоматически.
>
> **Критерий успеха:**
> - Точность расчета: отклонение от текущих методик < 0.1%.
> - Время выполнения расчета: < 0.2 сек.
> - Бесшовная передача данных: БД геометрии → Расчет → БД результатов (для Balance+).
> - Поддержка синтаксиса диапазонов (напр., `1000 2000` или `10-50-5`) во входных полях.

---

**Раздел 3. Пользователи и роли**

| Роль | Кто это | Что делает в системе |
|------|---------|---------------------|
| Инженер-расчётчик | Сотрудники бюро (БТР, БПР, БВП) | Выбирает конденсатор из БД, задает методику и термодинамические параметры (в т.ч. диапазоны), выполняет расчет, анализирует таблицы результатов, сохраняет в Git/Excel. |

---

**Раздел 4. Функциональные требования (Use Cases)**

**UC-01: Расчет в контексте задачи (Интеграция)**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Предусловие | Задача выбрана в Task Manager. |
| Основной сценарий | 1. Система проверяет наличие файла результатов (`JSON`) в репозитории.<br>2. **Если файл есть (Гидрация):**<br>   - Автоматически выбирается конденсатор по ID.<br>   - Автоматически выбирается материал.<br>   - Устанавливается сохраненная методика (Берман/Метро-Виккерс).<br>   - Поля заполняются сохраненными значениями (в т.ч. массивами данных).<br>3. **Если файла нет:**<br>   - Пользователь ищет и выбирает конденсатор (UC-03).<br>   - Пользователь выбирает материал (если указано несколько видов материала).<br>   - Выбирает методику расчета (по умолчанию блокируются лишние поля).<br>4. Пользователь вводит/корректирует параметры (поддерживается ввод диапазонов).<br>5. Нажимает «Рассчитать».<br>6. Система генерирует серию таблиц результатов.<br>7. Пользователь нажимает «Отправить результаты в GitLab». |

**UC-02: Автономный расчет (Direct Access)**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Предусловие | Пользователь авторизован, модуль открыт по прямой ссылке (вне контекста Task Manager). |
| Основной сценарий | 1. Пользователь ищет и выбирает конденсатор (см. UC-03).<br>2. Система автоматически подгружает геометрию.<br>3. Пользователь вводит параметры вручную.<br>4. Нажимает «Рассчитать».<br>5. Просматривает результаты.<br>6. Нажимает «Сохранить в Excel». |
| Результат | Сформирован и скачан `.xlsx` файл с отчетом. |

**UC-03: Поиск и выбор оборудования**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Основной сценарий | 1. Пользователь переходит на вкладку поиска.<br>2. Вводит маркировку или проект.<br>3. Система отображает найденные конденсаторы.<br>4. Пользователь выбирает оборудование.<br>5. Система проверяет полноту данных в БД для выбранной методики (BR-02). |

---

**Раздел 5. Бизнес-правила (Логика расчета)**

| ID | Правило | Описание / Логика |
|----|---------|-------------------|
| BR-01 | **Выбор методики** | При выборе методики UI блокирует (делает серыми) неиспользуемые поля:<br>**Берман:** Доступны `coefficient_b`, `G_steam`, `W_main`, `W_builtin`, `Z_ejectors`, `Z_main`, `Z_builtin`, `t1_main`, `t1_builtin`, `H_steam`.<br>**Метро-Виккерс:** Доступны `coefficient_b`, `G_steam`, `W_main`, `Z_main`, `X_steam`. |
| BR-02 | **Валидация БД** | Перед расчетом система проверяет наличие обязательных геометрических констант в БД [DB-EQUIP-CONDENSER](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/database_structure/DB-EQUIP-CONDENSER.md) для выбранной методики. Если данных нет — блокировать кнопку расчета и вывести ошибку. |
| BR-03 | **Значения по умолчанию** | `coefficient_b = 1`, `Z_ejectors = 1`, `X_steam = 0.950`. Данные значения заполняются в поля автоматически, но не исключают права пользователя их корректировать |
| BR-04 | **Синхронизация температур** | Принимается, что `t1_main = t1_builtin`. При вводе значения в одно поле, оно автоматически подбрасывается во второе (если не задано явно иное). |
| BR-05 | **Интерполяция загрязнения (b)** | Диапазон `coefficient_b`: [0 ... 1].<br>- Если `coefficient_b` в диапазоне [0.75 ... 1]: Линейная интерполяция коэффициента сопротивления.<br>- Если `coefficient_b` < 0.75: Линейная экстраполяция.<br>- Если `coefficient_b` > 1 или < 0: Ошибка валидации. |
| BR-06 | **Лимиты расходов (Pass limits)** | Проверять введенные `W_main`, `W_builtin` по данным из БД [DB-EQUIP-CONDENSER](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/database_structure/DB-EQUIP-CONDENSER.md) (min/max для конкретного числа ходов).<br>**Реакция:** Warning (Предупреждение), но расчет не блокировать. |
| BR-07 | **Лимиты одного пучка** | Проверять расходы при работе только одного пучка (по данным из БД [DB-EQUIP-CONDENSER](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/database_structure/DB-EQUIP-CONDENSER.md)), т.е. при вводе значения расхода охлаждающей воды ТОЛЬКО в одно поле (основной или встроенный пучок) производится проверка после нажатия кнопки расчет.<br>**Реакция:** Warning. |
| BR-08 | **Парсинг ввода (Range Input)** | Поля параметров поддерживают синтаксис:<br>1. Число: `1000`<br>2. Список: `1000 2000 3000` (через пробел)<br>3. Диапазон: `10-50-10` (Start-End-Step) → `10, 20, 30, 40, 50`<br>4. Количество точек: `10-50:5` (Start-End:Count) → 5 точек от 10 до 50. |
| BR-09 | **Логика матричного расчета** | 1. **Zipped Loop:** Массивы `W_main` и `W_builtin` должны быть одной длины, иначе выдаем ошибку. Они перебираются синхронно (пара `W_main[i] + W_builtin[i]`).<br>2. **Outer Loop:** Если задано несколько `coefficient_b`, для каждого создается отдельный набор таблиц.<br>3. **Matrix Loop:** Для каждой комбинации (coefficient_b, W) строится таблица, где оси — это массивы `t1` (строки) и `G_steam` (столбцы).<br>4. В ячейках таблицы — искомое давление `P_steam`. |
| BR-10 | **Температурные диапазоны** | **Берман:** Оптимален для 0...45°С. Если `t1` вне диапазона — Warning.<br>**Метро-Виккерс:** Оптимален для 45...150°С. Если `t1` вне диапазона — Warning. Проверка после нажатия на расчет.<br>**Реакция:** Warning. |
| BR-11 | **Экстраполяция MV** | Для Метро-Виккерс: если расчет попадает в расширенную (достроенную) часть кривой коэффициента K — выводить Warning: *"Данные не подтверждены экспериментально"*. |
| BR-12 | **Свойства материалов** | Коэффициент теплопроводности `lambda` материала подтягиваются из библиотеки материалов [DB-MATERIALS](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/database_structure/DB-MATERIALS.md), применяемых на предприятии, по `material_id` как зависимость $lambda = f(t_{avg})$. Для определения значения `lambda` мы используем линейную интерполяцию. Определив среднюю температуру определяем `lambda`и так до тех пор пока $t_{avg}^i <= t_{avg}^{i+1}$ где $i$ это итерации уточнения. |
| BR-13 | **Выходные данные** | Реализовать возможность вывода любого из парметров расчета (в т.ч. промежуточные) согласно методикам |

---

**Раздел 6. Данные**

**6.1. Входные данные (Пользовательский ввод)**

В UI все поля должны иметь Dropdown для смены единиц измерения (но расчет ведется в системных единицах). Для смены единиц измерения используем нашу билибиотеку `uniconv`.

| Название | Код | Ед. изм. (Default) | Точность UI | Тип ввода |
| :--- | :---: | :---: | :---: | :--- |
| Коэфф. загрязнения | `coefficient_b` | - | 0.01 | Array |
| Расход пара в к-р | `G_steam` | т/ч | 0.01 | Array (Axis X) |
| Расход охл. воды (осн. пучок) | `W_main` | т/ч | 0 | Array (Zipped) |
| Расход охл. воды (встр. пучок) | `W_builtin` | т/ч | 0 | Array (Zipped) |
| Темп. воды вход (осн. пучок) | `t1_main` | °С | 0.1 | Array (Axis Y) |
| Темп. воды вход (встр. пучок) | `t1_builtin` | °С | 0.1 | Array (Axis Y) |
| Кол-во раб. эжекторов | `Z_ejectors` | шт | 0 | Single |
| Ходы воды (осн. пучок) | `Z_main` | шт | 0 | Single |
| Ходы воды (встр. пучок) | `Z_builtin` | шт | 0 | Single |
| Энтальпия пара | `H_steam` | ккал/кг | 0.1 | Single |
| Степень сухости | `X_steam` | - | 0.001 | Single |

**6.2. Выходные данные**

| Название | Код | Ед. изм. | Точность UI | Комментарий |
| :--- | :---: | :---: | :---: | :--- |
| Давление в конденсаторе | `P_steam` | кгс/см² | 4 зн. цифры (например 125.5, 12.15, 0.145) | Основной результат (матрица) |

**6.3. Концептуальная модель данных (Frontend State)**

```json
{
  "taskId": "123",
  "configuration": {
    "condenserId": "uuid-condenser-db",
    "method": "berman" // or "metro-vickers"
  },
  "inputs": {
    "coefficient_b": [1, 0.75],
    "W_op": [1000, 2000],
    "W_builtin": [500, 750], // Длина должна совпадать с W_op
    "G_steam": [8, 20, 50],
    "t1_main": [10, 20],
    "H_steam": 560
    // ... остальные параметры
  },
  "results": [
    {
      "meta": { "coefficient_b": 1, "W_main": 1000, "W_builtin": 500 },
      "matrix": {
        "columns": [8, 20, 50], // G_steam
        "rows": [10, 20],       // t1
        "values": [             // P_steam
          [0.0451, 0.0520, 0.0610],
          [0.0650, 0.0710, 0.0820]
        ]
      }
    },
    {
      "meta": { "coefficient_b": 1, "W_main": 2000, "W_builtin": 750 },
      "matrix": { ... }
    }
    // ... блоки для других комбинаций
  ]
}
```

---

**Раздел 7. Прототип интерфейса**

**Экран 0: Поиск конденсатора**
* Поля по аналогии с журналом регистрации + поле наименование конденсатора

**Экран 1: Настройка расчёта**
*   **Header:** Карточка с краткими хар-ками + диапазоны согласно БД. Кнопка "Сменить".
*   **Method Selector:** Radio buttons [ Методика Бермана | Методика Метро-Виккерса ].
*   **Input Grid:**
    *   Поля группируются логически (Вода, Пар, Конструктив).
    *   Поля, недоступные для выбранной методики, визуально "задизейблены" (серый фон).
    *   Поля поддерживают валидацию диапазонов (tooltip с подсказкой формата ввода `10-50-5`).
    *   Рядом с полями `W_main`/`W_builtin` индикатор диапазона из БД (напр., "Допустимо: 800-2500").
*   **Action Panel:** Кнопка "Рассчитать".

**Экран 2: Результаты (Matrix View)**
*   **Группировка:** Сверху табы или аккордеон для переключения между "Кейсами" (комбинации `b` и `W`).
    *   *Пример заголовка таба:* `coefficient_b=1, W_main=1000, W_builtin=500`.
*   **Таблица:**
    *   Заголовки столбцов: Значения `G_steam`.
    *   Заголовки строк: Значения `t1`.
    *   Ячейки: Значение `P_steam`.
    *   Цветовое кодирование: Если значение экстраполировано или есть Warning — ячейка подсвечивается желтым (tooltip с деталями).
*   **Footer:** Кнопки "В Excel" (скачивание .xlsx), "Сохранить в GitLab".

Пример вывода данных:

 coefficient_b=1 W_main=1000 W_builtin=500
| t1 \ G_steam | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P1 | P2 | P3 |
| 20 | P4 | P5 | P6 |

coefficient_b=1 W_main=2000 W_builtin=750
| t1 \ G_steam | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P7 | P8 | P9 |
| 20 | P10 | P11 | P12 |

 coefficient_b=0.75 W_main=1000 W_builtin=500
| t1 \ G_steam | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P13 | P14 | P15 |
| 20 | P16 | P17 | P18 |

coefficient_b=0.75 W_main=2000 W_builtin=750
| t1 \ G_steam | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P19 | P20 | P21 |
| 20 | P22 | P23 | P24 |

---

**Раздел 8. Согласования**

| Роль | ФИО | Подпись/дата |
|------|-----|--------------|
| Заказчик | Деминов А.М. | |
| Аналитик | Шлегин Л.Р., Гаврилов П.Я. | |

---

**Definition of Ready (Критерии готовности к передаче)**

Задача считается выполненной, если:
1.  Спецификация утверждена заказчиком.
2.  БД конденсаторов наполнена тестовыми данными (минимум 3 типа с диапазонами расходов).
3.  Реализован парсер входных строк (Range/List parser) на фронтенде или бэкенде.
4.  Математическое ядро поддерживает векторизированный расчет (генерация матриц).
5.  Реализован экспорт результатов в Excel в требуемом формате.
6.  Интеграция: результаты сохраняются в JSON, который может прочитать программа «Баланс».

