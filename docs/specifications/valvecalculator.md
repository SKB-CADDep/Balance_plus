# Спецификация продукта «Модуль расчета штоков клапанов (WSA Valve Stems)»

---

**Раздел 1. Общая информация**

| Поле | Значение |
|------|----------|
| Название продукта | Расчётный модуль «Утечки через штоки клапанов» (Valve Stems) |
| Заказчик (отдел/человек) | Отдел инженерных расчётов (БТР, БПР, БВП) / Деминов А.М. |
| Аналитик | Шлёгин Л.Р., Гаврилов П.Я. |
| Дата передачи в разработку | 15.12.2025 |
| Приоритет | Высокий (Замена Legacy ПО) |
| Целевой срок Demo | Q2 2026 |
| Версия | 2.2 (Переработка legacy) |

---

**Раздел 2. Проблема и цель**

*Зачем это нужно? Какую боль решаем?*

> **Проблема:**
> Текущий процесс расчета штоков клапанов фрагментирован и выполняется в проприетарном/устаревшем ПО (SiTh, DOS).
> - Отсутствует версионирование расчетов.
> - Нет централизованного хранения данных (геометрия, результаты).
> - Отсутствует БД геометрии.
> - Разрыв контекста: ручной перенос данных (PDF-чертежи → txt-исходники → Excel-результаты → Word-отчеты).
> - Высокая трудоемкость подготовки данных.
>
> **Цель:**
> Реализовать принцип «Единого окна» (Single Window) для расчета утечек пара через штоки:
> 1. Создать единую БД геометрии клапанов.
> 2. Обеспечить связку «Проект — Геометрия — Результат».
> 3. Исключить использование сторонних файлов (txt/excel) в процессе расчета.
> 4. Автоматизировать определение расходов отбора/подвода пара.
>
> **Критерий успеха:**
> - Точность расчета: отклонение от текущих методик < 0.1%.
> - Время выполнения расчета: < 0.2 сек.
> - Бесшовная передача данных: БД геометрии → Расчет → БД результатов.
> - Надежная связка «ID задачи — Результат».

---

**Раздел 3. Пользователи и роли**

| Роль | Кто это | Что делает в системе |
|------|---------|---------------------|
| Инженер-расчётчик | Сотрудники бюро (БТР, БПР, БВП) | Выбирает геометрию (клапаны), вводит/корректирует термодинамические параметры, выполняет расчет, анализирует результаты, сохраняет их в Git или Excel. |

---

**Раздел 4. Функциональные требования (Use Cases)**

**UC-01: Расчет в контексте задачи (Интеграция с Task Manager)**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Предусловие | Задача выбрана в Task Manager. Модуль открыт в Iframe. |
| Основной сценарий | 1. Система проверяет наличие файла результатов (`JSON`) в репозитории проекта.<br>2. **Если файл есть (Гидрация):**<br>   - Автоматически выбираются клапаны (СК/РК) по ID.<br>   - Подгружается геометрия из БД.<br>   - Поля термодинамики заполняются сохраненными значениями.<br>3. **Если файла нет:**<br>   - Пользователь ищет и выбирает клапаны (см. UC-03).<br>4. Пользователь корректирует термодинамические параметры (исходные данные).<br>5. Пользователь нажимает «Рассчитать».<br>6. Система отображает результаты (таблицы по клапанам и сводные).<br>7. Пользователь нажимает «Отправить результаты в GitLab». |
| Результат | Файл результатов (`JSON`) с исходными данными и расчетом сохранен в ветку задачи. |

**UC-02: Автономный расчет (Direct Access)**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Предусловие | Пользователь авторизован, модуль открыт по прямой ссылке (вне контекста Task Manager). |
| Основной сценарий | 1. Пользователь ищет и выбирает клапаны (см. UC-03).<br>2. Система автоматически подгружает геометрию.<br>3. Пользователь вводит термодинамические параметры вручную.<br>4. Нажимает «Рассчитать».<br>5. Просматривает результаты.<br>6. Нажимает «Сохранить в Excel». |
| Результат | Сформирован и скачан `.xlsx` файл с отчетом. |

**UC-03: Поиск и выбор оборудования**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Основной сценарий | 1. Пользователь переходит на вкладку поиска.<br>2. Ищет клапаны (по отдельности Стопорные (СК) и Регулирующие (РК)).<br>3. При выборе одного типа (например, СК), система предлагает связанные варианты другого типа (РК), если связи заданы в БД.<br>4. Пользователь подтверждает выбор конфигурации. |

---

**Раздел 5. Бизнес-правила**

| ID | Правило | Описание / Логика |
|----|---------|-------------------|
| BR-01 | **Авто-топология** | Количество участков определяется автоматически исходя из геометрии (скрыто от пользователя).<br>Количество отсосов = `Количество участков - 1`. |
| BR-02 | **Распределение давлений** | Параметры перед ($P_0$) и за ($P_2$) участком определяются автоматически (см. Таблицу 5.1 ниже). Давление воздуха всегда берется барометрическое. |
| BR-03 | **Единицы измерения (Input)** | В полях ввода должны быть выпадающие списки (Dropdown) для выбора единиц.<br>**Defaults:**<br>- Давление: `кгс/см²`<br>- Температура: `°С`<br>- Энтальпия: `ккал/кг` |
| BR-04 | **Единицы измерения (Output)** | Результаты всегда выводятся в фиксированных единицах:<br>- Давление: `кгс/см²`<br>- Температура: `°С`<br>- Энтальпия: `ккал/кг`<br>- Расход: `т/ч` |
| BR-05 | **Агрегация результатов** | Если в расчете несколько клапанов одного типа (напр., 1 СК + 3 РК Тип-1 + 1 РК Тип-2), формируются **сводные таблицы**:<br>1. Суммарно по всем СК.<br>2. Суммарно по всем РК (все типы РК суммируются). |
| BR-06 | **Округление (Display)** | Округление применяется только для отображения на UI:<br>- Давление: 4 значащих цифры (25.00; 1.200; 0.245)<br>- Температура: до 0.1<br>- Энтальпия: до 0.1<br>- Расход: до 0.01 |
| BR-07 | **Валидация ошибок** | - Поле не заполнено → Подсветка поля + текст "Поле обязательно".<br>- Не число → Текст "Введите число".<br>- Физическое нарушение ($P_2 > P_1$) → Подсветка обоих полей + ошибка "Давление за участком выше начального". |
| BR-08 | **Методика расчета расхода** | Расчет ведется по формулам истечения пара через кольцевую щель (лабиринтное уплотнение).<br>Используется итерационный метод для определения критического давления (критического расхода). Ссылка на методику: [CALC-STEM-RTM](https://github.com/LevShlyogin/Balance_plus/blob/main/docs/methods/balance/CALC-STEM-RTM.md). |
| BR-09 | **Свойства рабочего тела** | Плотность и энтальпия пара на каждом участке определяются по IAPWS-97 на основе $P$ и $H_{const}$ (энтальпия считается постоянной по длине лабиринта, процесс дросселирования). |
| BR-10 | **Мнемосхема клапана** | Реализовать возможность выводить результаты расчета на схематичное изображение клапана. |
| BR-11 | **Ручной ввод геометрии** | Пользователь имеет право разблокировать поля геометрии (диаметр, зазор, длина участка и т.п.), подтянутые из БД, для выполнения кастомных расчетов. Такие поля должны подсвечиваться как «Modified». Такой расчет сохраняется только в Excel. |

**Таблица 5.1. Логика распределения давлений (BR-02)**

| Участков | Отсосов | Схема давлений (P0 → P2) |
| :---: | :---: | :--- |
| **2** | 1 | 1. Свежий пар → Отсос 1<br>2. Воздух → Отсос 1 |
| **3** | 2 | 1. Свежий пар → Отсос 1<br>2. Отсос 1 → Отсос 2<br>3. Воздух → Отсос 2 |
| **4** | 3 | 1. Свежий пар → Отсос 1<br>2. Отсос 1 → Отсос 2<br>3. Отсос 2 → Отсос 3<br>4. Воздух → Отсос 3 |
| **5** | 4 | 1. Свежий пар → Отсос 1<br>2. Отсос 1 → Отсос 2<br>3. Отсос 2 → Отсос 3<br>4. Отсос 3 → Отсос 4<br>5. Воздух → Отсос 4 |

---

**Раздел 6. Данные**

**6.1. Входные данные**

| Название | Код поля | Ед. изм. (Default) | Тип ввода | Примечание |
| :--- | :---: | :---: | :--- | :--- |
| Давление свежего пара | `P_fresh` | кгс/см² | Single | |
| Температура свежего пара | `T_fresh` | °С | Single | Взаимоисключающее с H |
| Энтальпия свежего пара | `H_fresh` | ккал/кг | Single | Взаимоисключающее с T |
| Давления в камерах отсоса | `P_leak_offs` | кгс/см² | Dynamic Array | Кол-во полей зависит от топологии клапана |

**6.2. Выходные данные**

| Данные | Потребитель | Формат | Состав |
|--------|-------------|--------|--------|
| Результат расчета (Git) | GitLab Repo | `result.json` | ID клапанов, Введенная термодинамика, Рассчитанные расходы (по участкам и суммарные) |
| Отчет (Скачивание) | Пользователь | `.xlsx` | Человекочитаемая таблица результатов |
| UI Display | Интерфейс | HTML | Таблицы по каждому клапану + Сводные (СК/РК) |

**6.3. Концептуальная модель данных (Frontend State):**

```json
{
  "projectId": "prj-123",
  "valves": [
    {
      "id": "uuid-valve-1",
      "type": "STOP_VALVE", // СК
      "designation": "СК-1 ЦВД",
      "geometry": {
        "stemDiameter": 100,
        "clearance": 0.25, // мм
        "segments": [5, 5] // кол-во гребней на участках
      },
      "thermoInput": {
        "p_fresh": 240,
        "t_fresh": 540,
        "p_leak_offs": [40, 1.2] // Давления в камерах отсоса
      },
      "results": {
        "flow_total": 150.5, // кг/ч
        "segments_data": [
          { "p_start": 240, "p_end": 40, "flow": 120.0 },
          { "p_start": 40, "p_end": 1.2, "flow": 30.5 }
        ]
      }
    }
  ],
  "summary": {
    "total_SK_leakage": 301.0,
    "total_RK_leakage": 50.5
  }
}
```

---

**Раздел 7. Прототип интерфейса**

Приложение состоит из 3-х логических экранов (вкладок или шагов):

1.  **Поиск и выбор (Search):**
    *   Поисковые строки для проекта / СК и РК.
    *   Карточки найденных клапанов.
    *   Механизм "Предложенные связи" (проекты).
    *   Механизм "Предложенные связи" (клапана).

2.  **Ввод данных (Input):**
    *   Секция "Параметры свежего пара" (с селектором P/T или P/H).
    *   Секция "Параметры отсосов" (динамическое кол-во полей).
    *   Секция "Геометрия" (отображение справочных данных readonly).
    *   Валидация "на лету" (красные рамки при ошибках).

3.  **Результаты (Output):**
    *   Таблица детализации (по каждому клапану).
    *   **Сводная таблица СК** (Сумма расходов).
    *   **Сводная таблица РК** (Сумма расходов).
    *   Кнопки действий: "Пересчитать" (назад), "В GitLab" / "В Excel".

4. **Схема:**
    *   Динамическая мнемосхема: Схематичное изображение штока и камер.
    *   Визуализация направления потоков (стрелочки).
    *   Подписи всех основных данных расчета
   

Пример вывода (по участкам):

|Обозначение |	Размерность	|1	|2	|3|
| --- | --- | --- | --- |--- |
|Z	|-	|2	|2	|2|
|d	|мм	|40	|40	|40|
|L	|мм	|313.5	|50	|97.5|
|delt	|мм	|0.215	|0.215	|0.215|
|f	|мм2	|27.02	|27.02	|27.02|
|P0	|кгс/см2	|130	|10	|1.03|
|T0	|°C	|555	|503.6	|40|
|v0	|м3/кг	|0.02767	|0.3629	|0.8869|
|P2	|кгс/см2	|10	|0.97	|0.97|
|Re	|-	|7.54E+04	|1.14E+04	|4282|
|w	|м/с	|152.6	|276.2	|31.88|
|G	|т/ч	|0.5366	|0.07403	|0.003496|

Пример вывода (по отсосам):

| Наименование отсоса	|Расход	|Давление	|Температура|
|---|---|---|---|
| ---	|т/ч	|кгс/см2	|°С|
|Отсос №1	|0.9251	|10	|503.6|
|Отсос №2	|0.155	|0.97	|478.5|

Пример вывода (схема):

<img width="306" height="505" alt="image" src="https://github.com/user-attachments/assets/96ee8893-bc6d-4479-bdea-43ba3b2b0c9b" />

---

**Раздел 8. Нефункциональные требования**

| Требование | Значение | Комментарий |
|------------|----------|-------------|
| Производительность расчёта | < 0.2 сек | Вычисления на клиенте или оптимизированном бэкенде |
| Точность | Не хуже 0.1% | Сверка с эталонной методикой |
| UX | Отсутствие "паразитных" кликов | Переходы по `Tab` между полями ввода |
| Локализация | Русский язык | Интерфейс и отчеты |

---

**Раздел 9. Открытые вопросы**

| Вопрос | Кто должен ответить | Срок |
|--------|--------------------| -----|
| Формат и источник миграции текущей БД геометрии (откуда первично наполнять базу)? | Архитектор / Заказчик | TBD |
| Структура JSON файла результатов (схема)? | Lead Developer | TBD |

---

**Раздел 10. Согласования**

| Роль | ФИО | Подпись/дата |
|------|-----|--------------|
| Заказчик | Деминов А.М. | |
| Аналитик | Шлёгин Л.Р., Гаврилов П.Я. | |

---

**Definition of Ready (Критерии готовности к передаче)**

Задача считается выполненной и готовой к приемке, если:

1.  **Согласование:** Спецификация утверждена заказчиком.
2.  **Данные:** БД геометрии клапанов спроектирована и наполнена минимальным набором тестовых данных (как минимум 1 тип Стопорного клапана и 2 типа Регулирующих клапанов для проверки связей).
3.  **Логика:** Реализован алгоритм «Авто-топологии» (BR-01, BR-02), который корректно определяет количество камер и распределяет давления без участия пользователя.
4.  **Физика:** Подключена библиотека свойств воды и водяного пара (IAPWS-97 или аналог) для точного расчета удельных объемов и энтальпий в каждой камере уплотнения.
5.  **Отчетность:** Реализован экспорт в Excel, включающий как детальную разбивку по камерам, так и **сводные таблицы** (суммирование утечек по группам СК и РК согласно BR-05).
6.  **Интеграция:** Утверждена схема JSON-структуры файла результатов (Input + Output), обеспечивающая корректное восстановление состояния формы (Гидрацию) при повторном открытии задачи.
